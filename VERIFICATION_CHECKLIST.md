# IAM ç”¨æˆ·ç»„åŒæ­¥åŠŸèƒ½éªŒè¯æ¸…å•

## ğŸ“‹ éªŒè¯å‰å‡†å¤‡

- [ ] æœåŠ¡å·²å¯åŠ¨å¹¶è¿è¡Œ
- [ ] MongoDB å·²è¿æ¥
- [ ] å·²åˆ›å»ºç§Ÿæˆ·ï¼ˆtenant_id: tenant-001ï¼‰
- [ ] å·²é…ç½®äº‘è´¦å·ï¼ˆcloud_account_id: 1ï¼‰
- [ ] äº‘è´¦å·çš„ tenant_id æ­£ç¡®è®¾ç½®

## âœ… åŠŸèƒ½éªŒè¯æ¸…å•

### 1. Tenant ID é…ç½®éªŒè¯

```bash
# è¿è¡Œå¿«é€Ÿæ£€æŸ¥
bash scripts/quick_check_tenant.sh
```

**éªŒè¯ç‚¹**:

- [ ] ç§Ÿæˆ·æ•°æ®å­˜åœ¨
- [ ] äº‘è´¦å·çš„ tenant_id æœ‰æ•ˆ
- [ ] ç”¨æˆ·çš„ tenant_id æœ‰æ•ˆ
- [ ] ç”¨æˆ·ç»„çš„ tenant_id æœ‰æ•ˆ

### 2. ç”¨æˆ·ç»„åŒæ­¥éªŒè¯

```bash
# æ‰§è¡ŒåŒæ­¥
curl -X POST "http://localhost:8080/api/v1/cam/iam/groups/sync?cloud_account_id=1" \
  -H "X-Tenant-ID: tenant-001" \
  -H "Content-Type: application/json"
```

**éªŒè¯ç‚¹**:

- [ ] è¿”å›çŠ¶æ€ç  200
- [ ] `total_groups` > 0
- [ ] `created_groups` æˆ– `updated_groups` > 0
- [ ] `total_members` > 0
- [ ] `synced_members` > 0
- [ ] `failed_groups` = 0ï¼ˆæˆ–å¯æ¥å—çš„å¤±è´¥æ•°ï¼‰
- [ ] `failed_members` = 0ï¼ˆæˆ–å¯æ¥å—çš„å¤±è´¥æ•°ï¼‰

**é¢„æœŸå“åº”**:

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "total_groups": 5,
    "created_groups": 2,
    "updated_groups": 3,
    "failed_groups": 0,
    "total_members": 15,
    "synced_members": 14,
    "failed_members": 1
  }
}
```

### 3. ç”¨æˆ·ç»„åˆ—è¡¨éªŒè¯

```bash
# æŸ¥è¯¢ç”¨æˆ·ç»„
curl -X GET "http://localhost:8080/api/v1/cam/iam/groups?page=1&size=10" \
  -H "X-Tenant-ID: tenant-001"
```

**éªŒè¯ç‚¹**:

- [ ] è¿”å›çŠ¶æ€ç  200
- [ ] `total` > 0
- [ ] `list` ä¸ä¸ºç©º
- [ ] æ¯ä¸ªç”¨æˆ·ç»„çš„ `cloud_account_id` = 1ï¼ˆä¸åŒæ­¥æ—¶ä¸€è‡´ï¼‰
- [ ] æ¯ä¸ªç”¨æˆ·ç»„çš„ `tenant_id` = "tenant-001"
- [ ] æ¯ä¸ªç”¨æˆ·ç»„çš„ `user_count` > 0ï¼ˆä¸æ˜¯ 0 æˆ– 1ï¼‰
- [ ] `user_count` ä¸å®é™…æˆå‘˜æ•°ä¸€è‡´
- [ ] `provider` æ­£ç¡®ï¼ˆaliyun/tencent ç­‰ï¼‰

**é¢„æœŸå“åº”**:

```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 1,
        "name": "å¼€å‘ç»„",
        "cloud_account_id": 1, // âœ“ æ­£ç¡®
        "tenant_id": "tenant-001", // âœ“ æ­£ç¡®
        "provider": "aliyun", // âœ“ æ­£ç¡®
        "user_count": 5, // âœ“ ä¸ä¸º 0
        "member_count": 5
      }
    ],
    "total": 5
  }
}
```

### 4. ç”¨æˆ·åˆ—è¡¨éªŒè¯

```bash
# æŸ¥è¯¢ç”¨æˆ·
curl -X GET "http://localhost:8080/api/v1/cam/iam/users?page=1&size=10" \
  -H "X-Tenant-ID: tenant-001"
```

**éªŒè¯ç‚¹**:

- [ ] è¿”å›çŠ¶æ€ç  200
- [ ] `total` > 0
- [ ] `list` ä¸ä¸ºç©ºï¼ˆä¸å†æ˜¯ç©ºæ•°ç»„ï¼‰
- [ ] æ¯ä¸ªç”¨æˆ·çš„ `tenant_id` = "tenant-001"
- [ ] æ¯ä¸ªç”¨æˆ·çš„ `cloud_account_id` = 1
- [ ] æ¯ä¸ªç”¨æˆ·çš„ `user_groups` ä¸ä¸ºç©º
- [ ] `user_groups` åŒ…å«æ­£ç¡®çš„ç”¨æˆ·ç»„ ID

**é¢„æœŸå“åº”**:

```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 1,
        "username": "test-user",
        "tenant_id": "tenant-001", // âœ“ æ­£ç¡®
        "cloud_account_id": 1, // âœ“ æ­£ç¡®
        "provider": "aliyun",
        "user_groups": [1, 2], // âœ“ ä¸ä¸ºç©º
        "status": "active"
      }
    ],
    "total": 14
  }
}
```

### 5. æ•°æ®ä¸€è‡´æ€§éªŒè¯

```bash
# è¿è¡Œé›†æˆæµ‹è¯•
cd scripts
go run test_group_member_sync.go
```

**éªŒè¯ç‚¹**:

- [ ] ç”¨æˆ·ç»„æ•°é‡ä¸åŒæ­¥ç»“æœä¸€è‡´
- [ ] ç”¨æˆ·æ•°é‡ä¸åŒæ­¥ç»“æœä¸€è‡´
- [ ] ç”¨æˆ·ç»„çš„ user_count ä¸å®é™…æˆå‘˜æ•°ä¸€è‡´
- [ ] æ‰€æœ‰ç”¨æˆ·éƒ½æœ‰æ­£ç¡®çš„ tenant_id
- [ ] æ‰€æœ‰ç”¨æˆ·ç»„éƒ½æœ‰æ­£ç¡®çš„ cloud_account_id

### 6. äº‘è´¦å·æ›´æ–°éªŒè¯

```bash
# æ›´æ–°äº‘è´¦å·çš„ tenant_id
curl -X PUT "http://localhost:8080/api/v1/cam/cloud-accounts/1" \
  -H "X-Tenant-ID: tenant-001" \
  -H "Content-Type: application/json" \
  -d '{"tenant_id": "tenant-001"}'
```

**éªŒè¯ç‚¹**:

- [ ] è¿”å›çŠ¶æ€ç  200
- [ ] æ›´æ–°æˆåŠŸ

```bash
# éªŒè¯æ›´æ–°ç»“æœ
curl -X GET "http://localhost:8080/api/v1/cam/cloud-accounts/1" \
  -H "X-Tenant-ID: tenant-001"
```

**éªŒè¯ç‚¹**:

- [ ] `tenant_id` = "tenant-001"ï¼ˆå·²æ›´æ–°ï¼‰

## ğŸ” é—®é¢˜æ’æŸ¥æ¸…å•

### é—®é¢˜ 1: æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨è¿”å›ç©º

**æ£€æŸ¥æ­¥éª¤**:

- [ ] æ£€æŸ¥è¯·æ±‚å¤´æ˜¯å¦åŒ…å« `X-Tenant-ID`
- [ ] æ£€æŸ¥ tenant_id æ˜¯å¦ä¸æ•°æ®åº“ä¸­çš„ä¸€è‡´
- [ ] è¿è¡Œ `bash scripts/quick_check_tenant.sh`
- [ ] è¿è¡Œ `go run scripts/fix_tenant_id.go`

### é—®é¢˜ 2: user_count ä¸º 0 æˆ– 1

**æ£€æŸ¥æ­¥éª¤**:

- [ ] ç¡®è®¤å·²åº”ç”¨æœ€æ–°çš„ä»£ç ä¿®å¤
- [ ] é‡æ–°æ‰§è¡Œç”¨æˆ·ç»„åŒæ­¥
- [ ] æ£€æŸ¥æ—¥å¿—ä¸­çš„ "æ›´æ–°ç”¨æˆ·ç»„æˆå‘˜æ•°é‡æˆåŠŸ" æ¶ˆæ¯
- [ ] æŸ¥çœ‹åŒæ­¥ç»“æœä¸­çš„ `synced_members` æ•°é‡

### é—®é¢˜ 3: cloud_account_id ä¸ä¸€è‡´

**æ£€æŸ¥æ­¥éª¤**:

- [ ] ç¡®è®¤å·²åº”ç”¨æœ€æ–°çš„ä»£ç ä¿®å¤
- [ ] é‡æ–°æ‰§è¡Œç”¨æˆ·ç»„åŒæ­¥
- [ ] æ£€æŸ¥åŒæ­¥æ—¶ä½¿ç”¨çš„ cloud_account_id
- [ ] æŸ¥çœ‹æ—¥å¿—ä¸­çš„ cloud_account_id ä¿¡æ¯

### é—®é¢˜ 4: åŒæ­¥å¤±è´¥

**æ£€æŸ¥æ­¥éª¤**:

- [ ] æ£€æŸ¥äº‘è´¦å·å‡­è¯æ˜¯å¦æœ‰æ•ˆ
- [ ] æ£€æŸ¥äº‘è´¦å·æ˜¯å¦æœ‰ RAM/CAM è¯»å–æƒé™
- [ ] æŸ¥çœ‹æœåŠ¡æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
- [ ] æµ‹è¯•äº‘è´¦å·è¿æ¥ï¼š`POST /api/v1/cam/cloud-accounts/{id}/test-connection`

## ğŸ“Š æ€§èƒ½éªŒè¯

### åŒæ­¥æ€§èƒ½

**æµ‹è¯•åœºæ™¯**: åŒæ­¥ 10 ä¸ªç”¨æˆ·ç»„ï¼Œæ¯ç»„ 5 ä¸ªæˆå‘˜

**éªŒè¯ç‚¹**:

- [ ] åŒæ­¥è€—æ—¶ < 30 ç§’
- [ ] æ— è¶…æ—¶é”™è¯¯
- [ ] æ— å†…å­˜æº¢å‡º
- [ ] CPU ä½¿ç”¨ç‡æ­£å¸¸

### æŸ¥è¯¢æ€§èƒ½

**æµ‹è¯•åœºæ™¯**: æŸ¥è¯¢ 100 ä¸ªç”¨æˆ·ç»„

**éªŒè¯ç‚¹**:

- [ ] å“åº”æ—¶é—´ < 1 ç§’
- [ ] åˆ†é¡µæ­£å¸¸å·¥ä½œ
- [ ] æ•°æ®å‡†ç¡®å®Œæ•´

## âœ… æœ€ç»ˆéªŒè¯

### å®Œæ•´æµç¨‹æµ‹è¯•

```bash
# 1. æ£€æŸ¥é…ç½®
bash scripts/quick_check_tenant.sh

# 2. ä¿®å¤é—®é¢˜ï¼ˆå¦‚æœæœ‰ï¼‰
go run scripts/fix_tenant_id.go

# 3. åŒæ­¥ç”¨æˆ·ç»„
curl -X POST "http://localhost:8080/api/v1/cam/iam/groups/sync?cloud_account_id=1" \
  -H "X-Tenant-ID: tenant-001"

# 4. æŸ¥è¯¢éªŒè¯
curl -X GET "http://localhost:8080/api/v1/cam/iam/groups" \
  -H "X-Tenant-ID: tenant-001"

curl -X GET "http://localhost:8080/api/v1/cam/iam/users" \
  -H "X-Tenant-ID: tenant-001"

# 5. è¿è¡Œé›†æˆæµ‹è¯•
cd scripts
go run test_group_member_sync.go
```

**æœ€ç»ˆéªŒè¯ç‚¹**:

- [ ] æ‰€æœ‰ API è°ƒç”¨æˆåŠŸ
- [ ] æ•°æ®å®Œæ•´å‡†ç¡®
- [ ] æ€§èƒ½ç¬¦åˆé¢„æœŸ
- [ ] æ— é”™è¯¯æ—¥å¿—

## ğŸ“ éªŒè¯æŠ¥å‘Šæ¨¡æ¿

```
éªŒè¯æ—¥æœŸ: 2025-11-23
éªŒè¯äºº: [å§“å]
ç¯å¢ƒ: [å¼€å‘/æµ‹è¯•/ç”Ÿäº§]

åŠŸèƒ½éªŒè¯:
âœ“ Tenant ID é…ç½®æ­£ç¡®
âœ“ ç”¨æˆ·ç»„åŒæ­¥æˆåŠŸ
âœ“ ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢æ­£å¸¸
âœ“ æ•°æ®ä¸€è‡´æ€§éªŒè¯é€šè¿‡

æ€§èƒ½éªŒè¯:
âœ“ åŒæ­¥è€—æ—¶: 15 ç§’
âœ“ æŸ¥è¯¢å“åº”: 0.5 ç§’

é—®é¢˜è®°å½•:
- æ— 

ç»“è®º: âœ… éªŒè¯é€šè¿‡
```

## ğŸ¯ éªŒè¯é€šè¿‡æ ‡å‡†

æ‰€æœ‰ä»¥ä¸‹æ¡ä»¶å¿…é¡»æ»¡è¶³:

1. âœ… Tenant ID é…ç½®æ£€æŸ¥é€šè¿‡
2. âœ… ç”¨æˆ·ç»„åŒæ­¥æˆåŠŸï¼ˆfailed_groups = 0ï¼‰
3. âœ… ç”¨æˆ·ç»„åˆ—è¡¨æŸ¥è¯¢æ­£å¸¸ï¼ˆuser_count æ­£ç¡®ï¼‰
4. âœ… ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢æ­£å¸¸ï¼ˆä¸ä¸ºç©ºï¼‰
5. âœ… æ•°æ®ä¸€è‡´æ€§éªŒè¯é€šè¿‡
6. âœ… äº‘è´¦å·æ›´æ–°åŠŸèƒ½æ­£å¸¸
7. âœ… æ€§èƒ½ç¬¦åˆé¢„æœŸ
8. âœ… æ— ä¸¥é‡é”™è¯¯æ—¥å¿—

---

**éªŒè¯æ¸…å•ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-23
